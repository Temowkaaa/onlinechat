<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="chat-container">

        <!-- Информация об онлайн-пользователях -->
        <div class="online">Пользователей онлайн: <span id="onlineCount">0</span></div>

        <h1>Анонимный голосовой чат</h1>

        <!-- Выбор пола -->
        <div class="gender-selection-columns">
            <!-- Столбец для выбора пола пользователя -->
            <div class="column">
                <p>Выберите ваш пол:</p>
                <button class="gender-btn" data-gender="male">Мужской</button>
                <button class="gender-btn" data-gender="female">Женский</button>
                <small id="userGenderHint" style="color: red; display: none;">Выберите ваш пол</small>
            </div>

            <!-- Столбец для выбора пола собеседника -->
            <div class="column">
                <p>Пол собеседника:</p>
                <button class="partner-gender-btn" data-gender="male">Мужской</button>
                <button class="partner-gender-btn" data-gender="female">Женский</button>
                <button class="partner-gender-btn" data-gender="any">Любой</button>
                <small id="partnerGenderHint" style="color: red; display: none;">Выберите предпочитаемый пол
                    собеседника</small>
            </div>
        </div>

        <div class="age-selection-columns">
            <!-- Столбец для выбора возраста пользователя -->
            <div class="column">
                <p>Выберите ваш возраст:</p>
                <div class="age-range-buttons">
                    <button class="user-age-btn" data-age="18-25">18–25 лет</button>
                    <button class="user-age-btn" data-age="26-35">26–35 лет</button>
                    <button class="user-age-btn" data-age="36-45">36–45 лет</button>
                    <button class="user-age-btn" data-age="46-60">46–60 лет</button>
                </div>
            </div>

            <!-- Столбец для выбора возраста собеседника -->
            <div class="column">
                <p>Возраст собеседника:</p>
                <div class="age-range-buttons">
                    <button class="partner-age-btn" data-range="18-25">18–25 лет</button>
                    <button class="partner-age-btn" data-range="26-35">26–35 лет</button>
                    <button class="partner-age-btn" data-range="36-45">36–45 лет</button>
                    <button class="partner-age-btn" data-range="46-60">46–60 лет</button>
                </div>
            </div>
        </div>

        <!-- Состояние поиска -->
        <div class="search-status" id="searchStatus">Готовы к общению</div>

        <button id="startChat" disabled>Начать общение</button>
        <button id="endChat">Завершить общение</button>

        <p>© Анонимный голосовой чат</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            query: {
                clientId: generateUniqueId()
            }
        });

        let peerConnection;
        const configuration = {
            iceServers: [{
                urls: 'stun:stun.l.google.com:19302'
            }]
        };

        // Переменные для хранения данных пользователя
        let selectedUserAgeRange = null;
        let selectedPartnerAgeRange = null;
        let userGender = null; // Пользовательский пол
        let partnerGender = null; // Предпочтительный пол собеседника

        // Генерация уникального ID клиента
        function generateUniqueId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Загрузка сохраненных предпочтений
        function loadPreferences() {
            const savedUserAge = localStorage.getItem('userAge');
            const savedPartnerAge = localStorage.getItem('partnerAge');
            const savedUserGender = localStorage.getItem('userGender');
            const savedPartnerGender = localStorage.getItem('partnerGender');

            if (savedUserAge) {
                document.querySelector(`.user-age-btn[data-age="${savedUserAge}"]`).click();
            }
            if (savedPartnerAge) {
                document.querySelector(`.partner-age-btn[data-range="${savedPartnerAge}"]`).click();
            }
            if (savedUserGender) {
                document.querySelector(`.gender-btn[data-gender="${savedUserGender}"]`).click();
            }
            if (savedPartnerGender) {
                document.querySelector(`.partner-gender-btn[data-gender="${savedPartnerGender}"]`).click();
            }
        }

        // Функция для проверки возможности активации кнопки "Начать общение"
        function checkStartButton() {
            if (
                selectedUserAgeRange &&
                selectedPartnerAgeRange &&
                userGender !== null &&
                partnerGender !== null
            ) {
                document.getElementById('startChat').disabled = false;
            } else {
                document.getElementById('startChat').disabled = true;
            }
        }

        // Обработка выбора возраста пользователя
        document.querySelectorAll('.user-age-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Сброс активного состояния всех кнопок
                document.querySelectorAll('.user-age-btn').forEach(btn => btn.classList.remove(
                    'active'));

                // Добавляем активное состояние выбранной кнопки
                button.classList.add('active');

                // Сохраняем выбранный диапазон
                selectedUserAgeRange = button.getAttribute('data-age');

                // Сохраняем выбор в localStorage
                localStorage.setItem('userAge', selectedUserAgeRange);

                // Проверяем, можно ли активировать кнопку "Начать общение"
                checkStartButton();
            });
        });

        // Обработка выбора диапазона возраста собеседника
        document.querySelectorAll('.partner-age-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Сброс активного состояния всех кнопок
                document.querySelectorAll('.partner-age-btn').forEach(btn => btn.classList.remove(
                    'active'));

                // Добавляем активное состояние выбранной кнопки
                button.classList.add('active');

                // Сохраняем выбранный диапазон
                selectedPartnerAgeRange = button.getAttribute('data-range');

                // Сохраняем выбор в localStorage
                localStorage.setItem('partnerAge', selectedPartnerAgeRange);

                // Проверяем, можно ли активировать кнопку "Начать общение"
                checkStartButton();
            });
        });

        // Обработка выбора пола пользователя
        document.querySelectorAll('.gender-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Сброс активного состояния всех кнопок
                document.querySelectorAll('.gender-btn').forEach(btn => btn.classList.remove('active'));

                // Добавляем активное состояние выбранной кнопки
                button.classList.add('active');

                // Сохраняем выбранный пол
                userGender = button.getAttribute('data-gender');

                // Сохраняем выбор в localStorage
                localStorage.setItem('userGender', userGender);

                // Проверяем, можно ли активировать кнопку "Начать общение"
                checkStartButton();

                // Скрываем подсказку
                document.getElementById('userGenderHint').style.display = 'none';
            });
        });

        // Обработка выбора пола собеседника
        document.querySelectorAll('.partner-gender-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Сброс активного состояния всех кнопок
                document.querySelectorAll('.partner-gender-btn').forEach(btn => btn.classList.remove(
                    'active'));

                // Добавляем активное состояние выбранной кнопки
                button.classList.add('active');

                // Сохраняем выбранный пол собеседника
                partnerGender = button.getAttribute('data-gender');

                // Сохраняем выбор в localStorage
                localStorage.setItem('partnerGender', partnerGender);

                // Проверяем, можно ли активировать кнопку "Начать общение"
                checkStartButton();

                // Скрываем подсказку
                document.getElementById('partnerGenderHint').style.display = 'none';
            });
        });

        document.getElementById('startChat').onclick = () => {
            if (!selectedUserAgeRange || !selectedPartnerAgeRange || userGender === null || partnerGender ===
                null) {
                alert('Пожалуйста, заполните все поля.');
                return;
            }

            // Разбиваем диапазоны на минимальное и максимальное значение
            const [minUserAge, maxUserAge] = selectedUserAgeRange.split('-').map(Number);
            const [minPartnerAge, maxPartnerAge] = selectedPartnerAgeRange.split('-').map(Number);

            // Отправляем данные на сервер
            socket.emit('joinQueue', {
                age: Math.floor((minUserAge + maxUserAge) / 2),
                minAge: minPartnerAge,
                maxAge: maxPartnerAge,
                userGender,
                partnerGender
            });

            document.getElementById('startChat').style.display = 'none';
            document.getElementById('endChat').style.display = 'block';

            document.getElementById('searchStatus').textContent = 'Ищем собеседника...';

            // Инициализация WebRTC
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('signal', {
                        candidate: event.candidate
                    });
                }
            };

            peerConnection.ontrack = event => {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.srcObject = event.streams[0];
                document.body.appendChild(audio);

                document.getElementById('searchStatus').textContent = 'Соединение установлено!';
            };

            // Обработка разрыва соединения
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'disconnected') {
                    document.getElementById('startChat').style.display = 'block';
                    document.getElementById('endChat').style.display = 'none';
                    document.getElementById('searchStatus').textContent = 'Готовы к общению';
                    location.reload(); // Перезагрузка страницы
                }
            };
        };

        document.getElementById('endChat').onclick = () => {
            socket.disconnect();
            location.reload(); // Перезагрузка страницы
        };

        // Обновление количества пользователей онлайн
        socket.on('updateOnlineCount', count => {
            const onlineCountElement = document.getElementById('onlineCount');
            onlineCountElement.textContent = count;

            // Добавляем класс для анимации
            if (count > parseInt(onlineCountElement.textContent)) {
                onlineCountElement.classList.add('increase');
                setTimeout(() => onlineCountElement.classList.remove('increase'), 500);
            } else if (count < parseInt(onlineCountElement.textContent)) {
                onlineCountElement.classList.add('decrease');
                setTimeout(() => onlineCountElement.classList.remove('decrease'), 500);
            }
        });

        // Обработка события "connectToPeer"
        socket.on('connectToPeer', async peerId => {
            socket.emit('signal', {
                sdp: await peerConnection.createOffer()
            });
            peerConnection.setRemoteDescription(new RTCSessionDescription(await peerConnection
                .createAnswer()));
        });

        // Обработка сигнализации
        socket.on('signal', signal => {
            if (signal.sdp) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.sdp));
                peerConnection.setLocalDescription(new RTCSessionDescription(signal.sdp));
            } else if (signal.candidate) {
                peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
            }
        });

        // Если собеседник не найден
        socket.on('noPartnerFound', () => {
            alert('Собеседник не найден. Попробуйте позже.');
            document.getElementById('startChat').style.display = 'block';
            document.getElementById('endChat').style.display = 'none';
            document.getElementById('searchStatus').textContent = 'Готовы к общению';
        });

        // Загружаем сохраненные предпочтения при загрузке страницы
        loadPreferences();
    </script>
</body>

</html>